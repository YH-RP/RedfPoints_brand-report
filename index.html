<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Red Points 2026 ç›£æ§å ±å‘Š</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@500;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #c0565b;       
            --primary-bg: #fff1f2; 
            --secondary: #475569;     
            --bg: #f8fafc;            
            --card-bg: #ffffff;
            --text-main: #334155;
            --text-light: #94a3b8;
        }

        body { font-family: 'Noto Sans TC', sans-serif; background: var(--bg); color: var(--text-main); margin: 0; padding: 40px 20px; }
        .container { max-width: 1200px; margin: 0 auto; }

        .header-section { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid #e2e8f0; }
        .header-title h1 { margin: 0; font-size: 28px; font-weight: 700; color: var(--secondary); letter-spacing: 1px; }
        .header-title span { font-size: 14px; color: var(--text-light); margin-top: 5px; display: block;}
        
        .upload-area { display: flex; gap: 10px; }
        .style-select { padding: 8px; border: 1px solid #cbd5e1; border-radius: 8px; color: var(--secondary); }
        .btn-upload { background: var(--primary); color: white; padding: 8px 20px; border-radius: 50px; cursor: pointer; border: none; box-shadow: 0 4px 10px rgba(192, 86, 91, 0.2); transition: 0.3s; }
        .btn-upload:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(192, 86, 91, 0.3); }
        #csvInput { display: none; }

        .section-box { margin-bottom: 40px; }
        .section-header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .section-title { font-size: 18px; color: var(--secondary); font-weight: 700; display: flex; align-items: center; gap: 8px; }
        .section-title::before { content: ''; width: 4px; height: 18px; background: var(--primary); border-radius: 2px; }
        .month-selector { padding: 5px 15px; border-radius: 20px; border: 1px solid var(--primary); color: var(--primary); background: white; cursor: pointer; outline: none; font-weight: bold; }

        .insight-card {
            background: linear-gradient(135deg, #fff 0%, #fffafa 100%);
            border-left: 5px solid var(--primary); border-radius: 12px; padding: 20px 25px; margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.03); border: 1px solid #f1f5f9;
        }
        .insight-title { font-size: 15px; font-weight: 700; color: var(--primary); margin-bottom: 10px; display: flex; align-items: center; gap: 5px; }
        .insight-content { font-size: 15px; line-height: 1.8; color: var(--secondary); }
        .highlight-num { font-weight: 700; color: #e76f51; background: #fff1f2; padding: 0 4px; border-radius: 4px; }
        .highlight-text { font-weight: 700; color: #264653; }

        .kpi-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; }
        .kpi-card { background: white; padding: 20px; border-radius: 12px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.02); transition: 0.3s; border: 1px solid #f1f5f9; }
        .kpi-num { font-size: 28px; font-weight: 700; color: var(--primary); font-family: 'Roboto', sans-serif; }
        .kpi-label { font-size: 13px; color: var(--text-light); }
        .kpi-unit { font-size: 12px; color: #cbd5e1; margin-top: 5px; }

        .assets-container { background: white; border-radius: 16px; padding: 25px; box-shadow: 0 4px 6px rgba(0,0,0,0.02); border: 1px solid #f1f5f9; }
        .chart-area { height: 320px; margin-bottom: 20px; }
        .custom-table { width: 100%; border-collapse: collapse; font-size: 14px; }
        .custom-table th { text-align: left; padding: 10px; color: #64748b; border-bottom: 2px solid #f1f5f9; }
        .custom-table td { padding: 10px; border-bottom: 1px solid #f8fafc; color: #334155; }
        .ytd-col { font-weight: bold; color: var(--primary); background: #fffafa; }

        .split-layout { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .chart-card { background: white; border-radius: 16px; padding: 20px; height: 320px; box-shadow: 0 4px 6px rgba(0,0,0,0.02); border: 1px solid #f1f5f9; }

        @media (max-width: 900px) {
            .kpi-grid { grid-template-columns: 1fr 1fr; }
            .split-layout { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header-section">
        <div class="header-title">
            <h1>Red Points Report</h1>
            <span id="statusText">è«‹åŒ¯å…¥ 2026 å¹´åº¦ CSV è³‡æ–™</span>
        </div>
        <div class="upload-area">
            <select id="encodingSelect" class="style-select">
                <option value="Big5">Big5 (Excelé è¨­)</option>
                <option value="UTF-8">UTF-8</option>
            </select>
            <label for="csvInput" class="btn-upload">ï¼‹ åŒ¯å…¥æª”æ¡ˆ</label>
            <input type="file" id="csvInput" accept=".csv" />
        </div>
    </div>

    <div class="section-box">
        <div class="section-header-row">
            <div class="section-title">1. é—œéµæŒ‡æ¨™ (KPI)</div>
            <select id="monthSelect" class="month-selector" style="display:none;"></select>
        </div>
        <div class="kpi-grid">
            <div class="kpi-card"><div class="kpi-label">åµæ¸¬æ•¸é‡</div><div class="kpi-num" id="kpi-detect">-</div><div class="kpi-unit">ç•¶æœˆä»¶æ•¸</div></div>
            <div class="kpi-card"><div class="kpi-label">æˆåŠŸä¸‹æ¶</div><div class="kpi-num" id="kpi-remove">-</div><div class="kpi-unit">ç•¶æœˆä»¶æ•¸</div></div>
            <div class="kpi-card"><div class="kpi-label">ä¸å¯åŸ·è¡Œ</div><div class="kpi-num" id="kpi-unable">-</div><div class="kpi-unit">ç•¶æœˆä»¶æ•¸</div></div>
            <div class="kpi-card"><div class="kpi-label">åŸ·è¡ŒæˆåŠŸç‡</div><div class="kpi-num" id="kpi-rate">-</div><div class="kpi-unit" style="color:#2a9d8f">æœ¬æœˆæ•ˆç‡</div></div>
            <div class="kpi-card"><div class="kpi-label">ç¶“æ¿Ÿå½±éŸ¿ (è¬)</div><div class="kpi-num" id="kpi-impact">-</div><div class="kpi-unit">æŒ½å›æå¤±</div></div>
        </div>
    </div>

    <div id="insightSection" class="section-box" style="display:none;">
        <div class="insight-card">
            <div class="insight-title">ğŸ’¡ <span id="insightMonthTitle">æœ¬æœˆè§€å¯Ÿé‡é»</span></div>
            <div class="insight-content" id="insightContent">è¨ˆç®—ä¸­...</div>
        </div>
    </div>

    <div class="split-layout">
        <div class="section-box" style="margin:0;">
            <div class="section-title" style="margin-bottom:20px;">2. ä¿è­·é¡å‹åˆ†ä½ˆ</div>
            <div class="chart-card"><canvas id="typeChart"></canvas></div>
        </div>
        <div class="section-box" style="margin:0;">
            <div class="section-title" style="margin-bottom:20px;">3. é«˜é¢¨éšªç¶²åŸŸæ’è¡Œ</div>
            <div class="chart-card"><canvas id="domainChart"></canvas></div>
        </div>
    </div>

    <div class="section-box" style="margin-top: 40px;">
        <div class="section-title" style="margin-bottom:20px;">4. åŸ·è¡Œæ•ˆèƒ½è¶¨å‹¢ (å¹´åº¦èµ°å‹¢)</div>
        <div class="split-layout">
            <div class="chart-card">
                <div style="font-size:14px; font-weight:bold; margin-bottom:10px; color:var(--secondary);">åµæ¸¬èˆ‡ä¸‹æ¶é‡å°æ¯”</div>
                <div style="height:250px;"><canvas id="trendChart"></canvas></div>
            </div>
            <div class="chart-card">
                <div style="font-size:14px; font-weight:bold; margin-bottom:10px; color:var(--secondary);">åŸ·è¡ŒæˆåŠŸç‡è¶¨å‹¢ (%)</div>
                <div style="height:250px;"><canvas id="rateTrendChart"></canvas></div>
            </div>
        </div>
    </div>

    <div class="section-box">
        <div class="section-title" style="margin-bottom:20px;">5. ä¾µæ¬Šè³‡ç”¢åˆ†æ (è¶¨å‹¢èˆ‡æ˜ç´°)</div>
        <div class="assets-container">
            <div class="chart-area"><canvas id="assetsChart"></canvas></div>
            <div style="overflow-x:auto;">
                <table class="custom-table" id="assetTable">
                    <thead><tr id="assetTableHeader"><th>è³‡ç”¢åç¨±</th></tr></thead>
                    <tbody id="assetTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    // --- Config ---
    Chart.register(ChartDataLabels); // è¨»å†Šæ•¸æ“šæ¨™ç±¤æ’ä»¶
    Chart.defaults.font.family = "'Noto Sans TC', sans-serif";
    Chart.defaults.color = '#94a3b8';
    
    // ä¿®æ­£é¡è‰²ï¼šç¬¬ä¸€å€‹æ”¹ç‚ºæ·±ç´… #c0565b
    const pastelColors = ['#c0565b', '#2a9d8f', '#e9c46a', '#264653', '#f4a261', '#8ab17d'];
    const months = ['1æœˆ','2æœˆ','3æœˆ','4æœˆ','5æœˆ','6æœˆ','7æœˆ','8æœˆ','9æœˆ','10æœˆ','11æœˆ','12æœˆ'];
    let globalData = null;
    let charts = {};

    // --- Events ---
    document.getElementById('csvInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const data = parseCSV(e.target.result);
                updateDashboard(data, file.name);
            } catch(err) { alert("è®€å–éŒ¯èª¤: " + err); }
        };
        reader.readAsText(file, document.getElementById('encodingSelect').value);
    });

    document.getElementById('monthSelect').addEventListener('change', (e) => {
        if(globalData) {
            const idx = parseInt(e.target.value);
            renderKPI(globalData, idx);
            generateInsights(globalData, idx);
        }
    });

    function parseCSV(csvText) {
        const lines = csvText.split(/\r\n|\n/);
        let section = null;
        let data = { detected:[], removed:[], unable:[], rate:[], impact:[], assets:{}, types:{}, domains:[] };

        lines.forEach(line => {
            if(!line.trim()) return;
            const cols = line.split(',');
            if(line.includes("æŒ‡æ¨™é …ç›®")) { section = "KPI"; return; }
            if(line.includes("ä¾µæ¬Šè³‡ç”¢")) { section = "Assets"; return; }
            if(line.includes("ä¿è­·é¡å‹")) { section = "Types"; return; }
            if(line.includes("ç¶²åŸŸæ´»å‹•")) { section = "Domains"; return; }

            const getVals = () => cols.slice(1, 13).map(v => {
                let n = parseFloat(v.toString().replace('%','')); return isNaN(n) ? null : n;
            });

            if(section === "KPI") {
                const vals = getVals();
                if(line.includes("åµæ¸¬æ•¸é‡")) data.detected = vals;
                if(line.includes("æˆåŠŸä¸‹æ¶")) data.removed = vals;
                if(line.includes("ä¸å¯åŸ·è¡Œ")) data.unable = vals;
                if(line.includes("åŸ·è¡ŒæˆåŠŸç‡")) data.rate = vals;
                if(line.includes("ç¶“æ¿Ÿå½±éŸ¿")) data.impact = vals;
            }
            if(section === "Assets" && !line.includes("åˆè¨ˆ") && cols[0].length > 2) {
                const vals = getVals();
                if(vals.some(v => v !== null)) data.assets[cols[0]] = vals;
            }
            if(section === "Types" && (line.includes("Counterfeit") || line.includes("Brand abuse"))) {
                data.types[cols[0]] = getVals(); 
            }
            if(section === "Domains" && cols[1] && cols[1].includes("(")) {
                const m = cols[1].match(/(.*) \((\d+)\)/);
                if(m) data.domains.push({ name: m[1].trim(), val: parseInt(m[2]) });
            }
        });
        return data;
    }

    function updateDashboard(data, filename) {
        globalData = data;
        let indices = [];
        data.detected.forEach((v, i) => { if(v !== null) indices.push(i); });
        const lastIdx = indices[indices.length - 1] || 0;
        document.getElementById('statusText').textContent = `ä¾†æº: ${filename} (è‡³ ${months[lastIdx]})`;
        
        const sel = document.getElementById('monthSelect');
        sel.innerHTML = '';
        indices.forEach(i => {
            let opt = document.createElement('option');
            opt.value = i; opt.text = months[i];
            sel.appendChild(opt);
        });
        sel.value = lastIdx;
        sel.style.display = 'block';

        renderKPI(data, lastIdx);
        generateInsights(data, lastIdx);
        renderAssetTable(data, lastIdx);
        renderCharts(data, lastIdx);
    }

    function renderKPI(data, idx) {
        document.getElementById('kpi-detect').textContent = data.detected[idx] || 0;
        document.getElementById('kpi-remove').textContent = data.removed[idx] || 0;
        document.getElementById('kpi-unable').textContent = data.unable[idx] || 0;
        let r = data.rate[idx];
        document.getElementById('kpi-rate').textContent = (r <= 1 ? (r*100).toFixed(1) : r) + "%";
        document.getElementById('kpi-impact').textContent = data.impact[idx] || 0;
    }

    function generateInsights(data, idx) {
        document.getElementById('insightSection').style.display = 'block';
        document.getElementById('insightMonthTitle').textContent = `ã€æœ¬æœˆè§€å¯Ÿé‡é» - ${months[idx]}ã€‘`;
        let assetList = [];
        for(let [name, vals] of Object.entries(data.assets)) assetList.push({ name: name, val: vals[idx] || 0 });
        assetList.sort((a, b) => b.val - a.val);
        const top1 = assetList[0] || { name: 'ç„¡', val: 0 };
        const top2 = assetList[1] || { name: 'ç„¡', val: 0 };
        const countCounterfeit = (data.types['Counterfeit'] && data.types['Counterfeit'][idx]) || 0;
        const total = countCounterfeit + ((data.types['Brand abuse'] && data.types['Brand abuse'][idx]) || 0);
        const pct = total > 0 ? ((countCounterfeit/total)*100).toFixed(1) : 0;
        
        document.getElementById('insightContent').innerHTML = `
            <span class="highlight-text">"${top1.name}"</span> èˆ‡ <span class="highlight-text">"${top2.name}"</span> 
            ä»ç‚ºä¸»è¦ä¾µæ¬Šå°è±¡ã€‚<br>å‡è²¨ (Counterfeit) ä½”æ¯”ç´„ <span class="highlight-num">${pct}%</span> (${countCounterfeit} ä»¶)ã€‚
        `;
    }

    function renderAssetTable(data, lastIdx) {
        const thead = document.getElementById('assetTableHeader');
        const tbody = document.getElementById('assetTableBody');
        let h = `<th>è³‡ç”¢åç¨±</th>`;
        for(let i=0; i<=lastIdx; i++) h += `<th>${months[i]}</th>`;
        h += `<th class="ytd-col">YTD ç¸½è¨ˆ</th>`;
        thead.innerHTML = h;

        let b = '';
        for(let [name, vals] of Object.entries(data.assets)) {
            let sum = 0;
            let row = `<td>${name}</td>`;
            for(let i=0; i<=lastIdx; i++) {
                let v = vals[i] || 0; sum += v;
                row += `<td>${v}</td>`;
            }
            row += `<td class="ytd-col">${sum}</td>`;
            b += `<tr>${row}</tr>`;
        }
        tbody.innerHTML = b;
    }

    function renderCharts(data, lastIdx) {
        const labels = months.slice(0, lastIdx + 1);

        // 1. åµæ¸¬èˆ‡ä¸‹æ¶è¶¨å‹¢åœ– (é¡¯ç¤ºæ•¸å­—)
        if(charts.trend) charts.trend.destroy();
        charts.trend = new Chart(document.getElementById('trendChart'), {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    { 
                        label: 'æˆåŠŸä¸‹æ¶', 
                        data: data.removed.slice(0, lastIdx+1), 
                        type: 'line', borderColor: '#c0565b', backgroundColor: '#c0565b',
                        tension: 0.3, borderWidth: 3, pointRadius: 4, order: 1,
                        datalabels: { align: 'top', anchor: 'end', color: '#c0565b', offset: 2 }
                    },
                    { 
                        label: 'åµæ¸¬æ•¸é‡', 
                        data: data.detected.slice(0, lastIdx+1), 
                        backgroundColor: '#cbd5e1', borderRadius: 4, order: 2,
                        datalabels: { align: 'center', anchor: 'center', color: '#475569' }
                    }
                ]
            },
            options: { 
                responsive: true, maintainAspectRatio: false,
                plugins: { 
                    legend: { position: 'bottom' },
                    datalabels: { font: { weight: 'bold', size: 10 }, formatter: Math.round }
                }
            }
        });

        // 2. æˆåŠŸç‡è¶¨å‹¢ (é¡¯ç¤ºæ•¸å­—)
        if(charts.rateTrend) charts.rateTrend.destroy();
        charts.rateTrend = new Chart(document.getElementById('rateTrendChart'), {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'æˆåŠŸç‡ %',
                    data: data.rate.slice(0, lastIdx+1).map(v => v > 1 ? v : v*100),
                    borderColor: '#2a9d8f', backgroundColor: 'rgba(42, 157, 143, 0.1)',
                    fill: true, tension: 0.3, pointRadius: 4,
                    datalabels: { align: 'top', anchor: 'end', color: '#2a9d8f', formatter: v => v.toFixed(1)+'%' }
                }]
            },
            options: { 
                responsive: true, maintainAspectRatio: false,
                scales: { y: { min: 0, max: 130 } }, // ç•™ç©ºé–“çµ¦æ¨™ç±¤
                plugins: { legend: { display: false }, datalabels: { font: { weight: 'bold' } } }
            }
        });

        // 3. é¡å‹åœ“é¤…åœ– (ä¸é¡¯ç¤ºæ•¸å­—ï¼Œé¿å…æ“æ“ )
        if(charts.types) charts.types.destroy();
        charts.types = new Chart(document.getElementById('typeChart'), {
            type: 'doughnut',
            data: {
                labels: Object.keys(data.types),
                datasets: [{ 
                    data: Object.keys(data.types).map(key => data.types[key][lastIdx] || 0),
                    backgroundColor: [pastelColors[0], '#cbd5e1'], borderWidth: 0
                }]
            },
            options: { 
                responsive: true, maintainAspectRatio: false, cutout: '70%',
                plugins: { datalabels: { display: false }, legend: { position: 'right' } }
            }
        });

        // 4. ç¶²åŸŸæ’è¡Œ (ä¸é¡¯ç¤ºæ•¸å­—)
        if(charts.domain) charts.domain.destroy();
        charts.domain = new Chart(document.getElementById('domainChart'), {
            type: 'bar',
            data: {
                labels: data.domains.map(d => d.name),
                datasets: [{ data: data.domains.map(d => d.val), backgroundColor: '#264653', borderRadius: 6 }]
            },
            options: { 
                indexAxis: 'y', responsive: true, maintainAspectRatio: false,
                plugins: { datalabels: { display: false }, legend: { display: false } }
            }
        });

        // 5. è³‡ç”¢è¶¨å‹¢åœ–
        if(charts.assets) charts.assets.destroy();
        let assetDatasets = []; let c = 0;
        for(let [k, v] of Object.entries(data.assets)) {
            assetDatasets.push({ label: k, data: v.slice(0, lastIdx+1), backgroundColor: pastelColors[c++ % pastelColors.length], borderRadius: 4 });
        }
        charts.assets = new Chart(document.getElementById('assetsChart'), {
            type: 'bar',
            data: { labels: labels, datasets: assetDatasets },
            options: { 
                responsive: true, maintainAspectRatio: false,
                scales: { x:{stacked:true}, y:{stacked:true} },
                plugins: { datalabels: { display: false } } // å †ç–Šåœ–ä¸é¡¯ç¤ºæ•¸å­—é¿å…æ··äº‚
            }
        });
    }
</script>
</body>
</html>
